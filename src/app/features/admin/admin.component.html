<div style="padding: 20px;">
  <div style="border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px;">
    <h1>Painel Admin</h1>
    <a routerLink="/" style="text-decoration: none; color: #007bff;">Voltar para Home</a>
  </div>

  <div *ngIf="error" style="padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; margin-bottom: 20px;">
    {{ error }}
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin: 0;">Usuarios</h2>
        <button (click)="toggleCreateUserForm()"
                style="padding: 10px 20px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 4px;">
          {{ showCreateUserForm ? 'Cancelar' : 'Criar Novo Usuário' }}
        </button>
      </div>

      <div *ngIf="showCreateUserForm" style="border: 1px solid #28a745; padding: 20px; margin-bottom: 20px; background-color: #f0fff4; border-radius: 4px;">
        <h3 style="margin-top: 0; color: #28a745;">Criar Novo Usuário</h3>
        <form [formGroup]="createUserForm" (ngSubmit)="createUser()">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Username *</label>
            <input formControlName="username" type="text"
                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <span *ngIf="getFieldError('username')" style="color: #dc3545; font-size: 12px;">
              {{ getFieldError('username') }}
            </span>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email *</label>
            <input formControlName="email" type="email"
                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <span *ngIf="getFieldError('email')" style="color: #dc3545; font-size: 12px;">
              {{ getFieldError('email') }}
            </span>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome *</label>
              <input formControlName="firstName" type="text"
                     style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <span *ngIf="getFieldError('firstName')" style="color: #dc3545; font-size: 12px;">
                {{ getFieldError('firstName') }}
              </span>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Sobrenome *</label>
              <input formControlName="lastName" type="text"
                     style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <span *ngIf="getFieldError('lastName')" style="color: #dc3545; font-size: 12px;">
                {{ getFieldError('lastName') }}
              </span>
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Senha Temporária *</label>
            <input formControlName="password" type="password"
                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <span *ngIf="getFieldError('password')" style="color: #dc3545; font-size: 12px;">
              {{ getFieldError('password') }}
            </span>
            <small style="display: block; color: #666; margin-top: 3px;">
              O usuário será obrigado a alterar a senha no primeiro login
            </small>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input formControlName="sendVerificationEmail" type="checkbox" style="margin-right: 8px;">
              <span>Enviar email de verificação</span>
            </label>
          </div>

          <div style="display: flex; gap: 10px;">
            <button type="submit"
                    [disabled]="submittingUser"
                    style="padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px;">
              {{ submittingUser ? 'Criando...' : 'Criar Usuário' }}
            </button>
            <button type="button"
                    (click)="toggleCreateUserForm()"
                    style="padding: 10px 20px; cursor: pointer; background-color: #6c757d; color: white; border: none; border-radius: 4px;">
              Cancelar
            </button>
          </div>
        </form>
      </div>

      <div *ngIf="loading" style="text-align: center; padding: 20px;">
        Carregando usuarios...
      </div>

      <div *ngIf="!loading" style="border: 1px solid #ccc;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #f8f9fa;">
              <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ccc;">Username</th>
              <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ccc;">Email</th>
              <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ccc;">Acao</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users"
                [style.background-color]="selectedUser?.id === user.id ? '#e7f3ff' : 'white'"
                style="border-bottom: 1px solid #eee;">
              <td style="padding: 10px;">{{ user.username }}</td>
              <td style="padding: 10px;">{{ user.email }}</td>
              <td style="padding: 10px;">
                <button (click)="selectUser(user)" style="padding: 5px 10px; cursor: pointer;">
                  Gerenciar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div>
      <h2>Gestao de Roles</h2>

      <div *ngIf="!selectedUser" style="padding: 20px; text-align: center; border: 1px solid #ccc;">
        Selecione um usuario para gerenciar roles
      </div>

      <div *ngIf="selectedUser" style="border: 1px solid #ccc; padding: 15px;">
        <h3>Usuario: {{ selectedUser.username }}</h3>
        <p><strong>Email:</strong> {{ selectedUser.email }}</p>
        <p><strong>ID:</strong> {{ selectedUser.id }}</p>

        <div style="margin-top: 20px;">
          <h4>Roles Disponiveis</h4>
          <p style="font-size: 12px; color: #666;">Clique para adicionar/remover roles</p>

          <div *ngFor="let role of availableRoles" style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; padding: 8px; border: 1px solid #ccc; cursor: pointer;"
                   [style.background-color]="hasRole(role.name) ? '#d4edda' : 'white'">
              <input type="checkbox"
                     [checked]="hasRole(role.name)"
                     (change)="toggleRole(role)"
                     style="margin-right: 10px;">
              <div>
                <strong>{{ role.name }}</strong>
                <div *ngIf="role.description" style="font-size: 12px; color: #666;">
                  {{ role.description }}
                </div>
              </div>
            </label>
          </div>
        </div>

        <div style="margin-top: 20px; padding: 10px; background-color: #f8f9fa;">
          <h4>Roles Atuais do Usuario</h4>
          <div *ngIf="userRoles.length === 0">
            Nenhuma role atribuida
          </div>
          <ul *ngIf="userRoles.length > 0">
            <li *ngFor="let role of userRoles">{{ role.name }}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <app-flow-explanation title="Fluxo: Gerenciamento de Roles" [defaultOpen]="false">
    <p style="margin-bottom: 10px;"><strong>Como funciona a gestao de roles:</strong></p>
    <ol style="margin: 10px 0; padding-left: 20px;">
      <li>Voce (admin) acessa esta pagina</li>
      <li>adminGuard verifica se voce tem role "admin"</li>
      <li>Angular busca lista de usuarios via Admin API</li>
      <li>Keycloak valida seu token e retorna usuarios</li>
      <li>Voce seleciona um usuario da lista</li>
      <li>Angular busca as roles atuais desse usuario</li>
      <li>Voce marca/desmarca roles usando checkboxes</li>
      <li>Angular envia POST (adicionar) ou DELETE (remover) para Keycloak</li>
      <li>Keycloak atualiza as role-mappings do usuario</li>
      <li>Feedback de sucesso/erro e exibido</li>
    </ol>
    <div style="margin-top: 10px; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107;">
      <p style="margin: 0;"><strong>Informacoes Importantes:</strong></p>
      <ul style="margin: 10px 0; padding-left: 20px;">
        <li>Requer role "admin" no Keycloak</li>
        <li>Alteracoes aplicadas imediatamente no Keycloak</li>
        <li>Usuario afetado precisa fazer logout/login para ver novas roles</li>
        <li>Token Bearer e validado em cada requisicao</li>
      </ul>
    </div>
    <app-mermaid-diagram [diagram]="adminFlowDiagram"></app-mermaid-diagram>
  </app-flow-explanation>
</div>
